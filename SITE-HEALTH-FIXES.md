# Исправление проблем «Здоровье сайта» (WordPress)

Проверка: **Инструменты → Здоровье сайта** на проде (https://45.141.102.187.nip.io).

**Быстрый запуск (на сервере):** скрипт `scripts/fix-site-health-on-server.sh` правит `wp-config.php` (отключает вывод ошибок) и добавляет запись в `/etc/hosts` для loopback. С локальной машины:  
`ssh root@45.141.102.187 'REMOTE_PATH=/opt/oor-webstudio SITE_HOST=45.141.102.187.nip.io bash -s' < scripts/fix-site-health-on-server.sh`

---

## Критические проблемы

### 1. Отображение ошибок для посетителей (безопасность)

**Причина:** Включены `WP_DEBUG` и вывод ошибок в браузер (`WP_DEBUG_DISPLAY` или аналог).

**Что сделать на сервере:**

1. Подключиться по SSH: `ssh root@45.141.102.187`
2. Открыть конфиг WordPress (путь по вашему развёртыванию, например):  
   `nano /opt/oor-webstudio/wp-config.php`
3. Найти или добавить строки и **привести к такому виду**:

```php
define( 'WP_DEBUG', false );           // на проде всегда false
define( 'WP_DEBUG_DISPLAY', false );   // не показывать ошибки в браузере
define( 'WP_DEBUG_LOG', false );       // при необходимости логи в wp-content/debug.log
@ini_set( 'display_errors', 0 );
```

Если нужна отладка только в лог (без вывода на экран):

```php
define( 'WP_DEBUG', true );
define( 'WP_DEBUG_DISPLAY', false );
define( 'WP_DEBUG_LOG', true );
@ini_set( 'display_errors', 0 );
```

4. Сохранить файл и проверить снова «Здоровье сайта».

---

### 2. REST API выдал ошибку / петлевой запрос (loopback)

Ошибка вида: `CURL error 28: Connection timed out` при обращении к `https://45.141.102.187.np.io/wp-json/...`.

**Возможные причины и действия:**

- **Файрвол блокирует исходящие запросы с сервера на свой же домен/IP.**  
  Разрешите исходящий HTTPS на тот же хост (или localhost, если WordPress обращается сам к себе по внутреннему URL).
- **Сервер не может резолвить свой домен** (например, `45.141.102.187.nip.io`).  
  Добавьте в `/etc/hosts` на сервере строку:
  ```text
  127.0.0.1   45.141.102.187.nip.io
  ```
  (или замените на ваш реальный домен, если он другой.)
- **Nginx/прокси не проксирует запросы к REST API.**  
  Убедитесь, что запросы к `/wp-json` и к основному домену сайта доходят до PHP (WordPress).
- **Таймаут слишком маленький.**  
  В `wp-config.php` можно временно увеличить таймаут для теста (не заменяет исправление сети):
  ```php
  if ( ! defined( 'WP_HTTP_BLOCK_EXTERNAL' ) ) {
      define( 'WP_HTTP_BLOCK_EXTERNAL', false );
  }
  ```
  Сама по себе эта константа не решает таймаут — важно открыть доступ к loopback (см. выше).

После изменений перезапустите PHP-FPM и при необходимости Nginx, затем снова запустите проверку в «Здоровье сайта».

---

## Рекомендуемые улучшения

### 3. ~~Удалить неактивные плагины и темы~~ (не делаем)

По желанию можно удалять неиспользуемые плагины и темы в админке (**Плагины**, **Внешний вид → Темы**). Сейчас не выполняем.

---

### 4. Обновить PHP до 8.3+

Сайт сейчас на PHP 8.2.30; рекомендуемая минимальная версия — 8.3.

**На сервере (зависит от способа установки PHP):**

- **Docker:** в образе/`Dockerfile` перейти на образ с PHP 8.3, например `wordpress:6.4-php8.3-fpm`, пересобрать и перезапустить контейнеры.
- **Системный PHP:** обновить пакеты (apt/yum) до PHP 8.3 и переключить сайт на новый PHP-FPM pool.

Перед обновлением проверьте совместимость плагинов и темы с PHP 8.3.

---

### 5. Планировщик: просроченные действия и пропущенное задание

Сообщения: «Найдено 3 просроченных действия», «Запланированное задание `action_scheduler_run_queue` было пропущено».

**Что сделать:**

1. **Проверить cron на сервере.**  
   Должна быть строка, которая каждую минуту вызывает WP-Cron:
   ```bash
   * * * * * cd /path/to/wordpress && wp cron event run --due-now
   ```
   или обращение к `https://ваш-сайт/wp-cron.php?doing_wp_cron` (если не отключён внешний вызов).
2. **Один раз вручную прогнать очередь:**  
   В админке: **Инструменты → Site Health** (или плагин, который использует Action Scheduler). Либо по SSH:
   ```bash
   wp action-scheduler run
   ```
   (если установлен WP-CLI.)
3. Убедиться, что на сервере верно настроены часы (NTP) и что PHP/веб-сервер имеют права на выполнение cron-задач.

После исправления cron и ручного запуска очереди предупреждения в «Здоровье сайта» должны исчезнуть при следующей проверке.

---

## Чек-лист

| Пункт | Действие | Где |
|-------|----------|-----|
| Ошибки в браузере | Выключить `WP_DEBUG_DISPLAY`, на проде лучше `WP_DEBUG` = false | `wp-config.php` на сервере |
| REST API / loopback | Файрвол, `/etc/hosts`, прокси для `/wp-json` | Сервер / Nginx |
| PHP 8.3+ | Обновить образ/пакет PHP | Сервер / Docker |
| Планировщик / cron | Настроить cron, запустить `action_scheduler_run_queue` | Сервер + WP-CLI или админка |

После всех правок снова откройте **Инструменты → Здоровье сайта** и убедитесь, что критические пункты исчезли, а рекомендации выполнены по возможности.
