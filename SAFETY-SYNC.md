# Безопасная разработка и синхронизация (одностороннее зеркало)

## Принцип «Стена безопасности»

| | PROD (сервер) | LOCAL (локалка) |
|---|---------------|-----------------|
| **Роль** | Источник правды (контент: БД + Uploads) | Песочница для разработки |
| **Направление данных** | Данные **только стягиваются** на локалку | Никогда не пушим БД или `uploads` на сервер через автоматику |
| **Git** | Переносит только **код темы** (логику) | То же |

- Код темы на сервер: `git push` + деплой темы (например, `deploy-theme-to-vps.sh`) или ручной выкат.
- Контент (БД, медиа) на локалку: только скрипт **pull-prod.sh** (PROD → LOCAL). Обратно на прод не отправляется.

## Деплой темы и метка версии

При каждом запуске `deploy-theme-to-vps.sh` в HTML футера на проде подставляется комментарий с **точным временем деплоя** и **версией** (короткий хеш коммита git):

```html
<!-- deploy: 2026-02-09T15:30:00+03:00 abc1234 -->
```

- **Время** — в формате ISO 8601 (дата и время деплоя по машине, с которой запущен скрипт).
- **Версия** — `git rev-parse --short HEAD` (например, `54064f4`); если git недоступен — `n/a`.

В репозитории в `footer.php` хранятся плейсхолдеры `{{DEPLOY_TIMESTAMP}}` и `{{DEPLOY_VERSION}}`; скрипт перед rsync подставляет фактические значения, после выката возвращает плейсхолдеры обратно (чтобы не коммитить время каждого деплоя).

**Где смотреть:** исходный код любой страницы на проде (ПКМ → «Просмотр кода страницы» или DevTools) — в начале футера будет комментарий `<!-- deploy: … -->`.

## Тест деплоя на сервер

Проверенный сценарий (на сервере нет git — выкат только через rsync):

1. Внести изменение в тему локально (например, в `wp-content/themes/oor-theme/`).
2. `git add … && git commit -m "…" && git push origin main`.
3. Выкатить тему на сервер: `bash scripts/deploy-theme-to-vps.sh` (по SSH-ключу; при необходимости задать `DEPLOY_PASSWORD`). В футере на проде появится актуальная метка времени и версии.
4. Проверить прод: https://45.141.102.187.nip.io (в исходном коде страницы — комментарий `<!-- deploy: … -->`).

Если меняется один файл, можно точечно:  
`rsync -avz -e "ssh -o StrictHostKeyChecking=accept-new" wp-content/themes/oor-theme/путь/файл root@45.141.102.187:/opt/oor-webstudio/wp-content/themes/oor-theme/путь/`  
(при точечном rsync метка деплоя в футере не обновится — для этого нужен полный запуск скрипта.)

## Локальный HTTPS

- После клона: `bash scripts/generate-local-certs.sh` (создаёт `certs/local.crt` и `certs/local.key`).
- Запуск: `docker compose up -d`.
- Сайт локально: **https://localhost:8443** (HTTP на 8080 редиректит на 8443).

## Скрипт безопасного импорта (pull-prod.sh)

Обновляет локалку до состояния сервера, **не трогая сервер**:

```bash
# В .env задать PROD_DB_ROOT_PASSWORD (пароль root MySQL на сервере)
bash scripts/pull-prod.sh
```

Скрипт:

1. Бэкапит текущую локальную БД в `local_backup_*.sql`.
2. Качает дамп БД с сервера и импортирует локально.
3. Делает search-replace: URL прода → `https://localhost:8443`.
4. Докачивает недостающие файлы из `wordpress-uploads` с сервера (rsync).

Опционально в `.env`: `REMOTE_SSH`, `REMOTE_DB_CONTAINER`, `REMOTE_UPLOADS_PATH`, `LOCAL_URL`, `PROD_URL`.

## Правила безопасности (Anti-Nuke)

1. **Не делать `git add .`**, если в каталоге есть непреднамеренные файлы из `uploads`. В `.gitignore` уже есть `wordpress-uploads/` и `wp-content/uploads/`.
2. **Синхронизация только PROD → LOCAL.** Переносить что-то на сервер:
   - **Код темы** — через `git push` и деплой темы (или ручной выкат).
   - **Контент/медиа** — через админку WordPress на проде или отдельный ручной процесс, не через этот репозиторий.
3. **Пароли прода** (например, `PROD_DB_ROOT_PASSWORD`) хранить только в локальном `.env`, не коммитить.

## Подсказки для Cursor (контекст для агента)

- **Стили/тема:** «Работаю в теме oor-theme. Публичные файлы в `public/`, исходники в `src/`. Не меняй ничего в папке uploads — медиа подбираю вручную.»
- **БД/миграции:** «Изменения в БД делай через PHP-миграцию или wp-cli, не предлагай ручной импорт SQL.»
- **URL/HTTPS:** «Локально сайт за Nginx на порту 8443. Ссылки должны идти через `get_stylesheet_directory_uri()` и аналоги.»

## Версия WordPress и PHP

Чтобы совпадать с продом: на сервере посмотреть `wp-includes/version.php` (или через SSH: `cat wp-includes/version.php`). В `Dockerfile.wordpress` используется образ с PHP 8.3 (рекомендация «Здоровья сайта»); для совпадения с продом при необходимости смените тег (например, `wordpress:6.4-php8.3-fpm`).

## Сертификаты на проде

Тот же `nginx.conf` ожидает в volume `/etc/nginx/ssl` файлы **local.crt** и **local.key**. На проде положите в каталог `certs/` ваши сертификаты (Let's Encrypt и т.п.) с именами `local.crt` и `local.key`, либо настройте `docker-compose.override.yml` и монтируйте свой каталог с сертификатами.
