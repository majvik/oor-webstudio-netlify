# Переменные из .env: DB_*, WP_*, порты (опционально для VPS)
# Для локальной разработки: cp .env.example .env, затем bash scripts/generate-local-certs.sh
# Локальный HTTPS: https://localhost:8443 (сертификаты в certs/)

services:
  wordpress:
    build:
      context: .
      dockerfile: Dockerfile.wordpress
    container_name: oor-wordpress
    restart: unless-stopped
    environment:
      WORDPRESS_DB_HOST: db
      WORDPRESS_DB_USER: ${DB_USER:-wordpress}
      WORDPRESS_DB_PASSWORD: ${DB_PASSWORD:-wordpress}
      WORDPRESS_DB_NAME: ${DB_NAME:-wordpress}
      WORDPRESS_DEBUG: ${WP_DEBUG:-0}
      PHP_INI_SCAN_DIR: /usr/local/etc/php/conf.d
    extra_hosts:
      # Loopback/REST API: хост сайта должен резолвиться в nginx, иначе таймаут из контейнера
      - "45.141.102.187.nip.io:172.28.0.250"
      - "localhost:172.28.0.250"
    volumes:
      - wordpress-data:/var/www/html
      - ./wp-content:/var/www/html/wp-content:rw
      - ./wordpress-uploads:/var/www/html/wp-content/uploads:rw
      - ./wp-content/mu-plugins:/var/www/html/wp-content/mu-plugins:rw
    depends_on:
      - db
    networks:
      - oor-network

  nginx:
    image: nginx:alpine
    container_name: oor-nginx
    restart: unless-stopped
    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTP_ALT_PORT:-8080}:80"
      - "${HTTPS_PORT:-443}:443"
      - "${HTTPS_ALT_PORT:-8443}:443"
    volumes:
      - wordpress-data:/var/www/html:ro
      - ./wp-content:/var/www/html/wp-content:ro
      - ./wordpress-uploads:/var/www/html/wp-content/uploads:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./certs:/etc/nginx/ssl:ro
      - ./certbot-webroot:/var/www/certbot:ro
    depends_on:
      - wordpress
    networks:
      oor-network:
        ipv4_address: 172.28.0.250

  db:
    image: mysql:8.0
    container_name: oor-mysql
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: ${DB_NAME:-wordpress}
      MYSQL_USER: ${DB_USER:-wordpress}
      MYSQL_PASSWORD: ${DB_PASSWORD:-wordpress}
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-rootpassword}
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - oor-network

  phpmyadmin:
    image: phpmyadmin:latest
    container_name: oor-phpmyadmin
    restart: unless-stopped
    ports:
      - "${PHPMYADMIN_PORT:-8081}:80"
    environment:
      PMA_HOST: db
      PMA_USER: ${DB_USER:-wordpress}
      PMA_PASSWORD: ${DB_PASSWORD:-wordpress}
    depends_on:
      - db
    networks:
      - oor-network

volumes:
  mysql-data:
  wordpress-data:

networks:
  oor-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/24
